import streamlit as st
import pandas as pd
import re

def extract_matricule_precise(df_raw):
    """Cherche sp√©cifiquement le mot 'MATRICULE' et extrait les chiffres associ√©s."""
    for row in df_raw.values:
        for cell in row:
            cell_str = str(cell).upper()
            if "MATRICULE" in cell_str:
                # Extrait uniquement les chiffres (ex: 00941)
                match = re.search(r'(\d+)', cell_str)
                if match:
                    return match.group(1)
                # Si non trouv√© dans la m√™me cellule, on peut chercher dans la cellule suivante
                # mais le regex ci-dessus couvre g√©n√©ralement 'MATRICULE : 00941'
    return "Non trouv√©"

def decimal_to_time(decimal_hours):
    if pd.isna(decimal_hours) or decimal_hours == "":
        return "00:00"
    try:
        total_seconds = int(float(decimal_hours) * 3600)
        hours = total_seconds // 3600
        minutes = (total_seconds % 3600) // 60
        return f"{hours:02d}:{minutes:02d}"
    except:
        return "00:00"

st.set_page_config(page_title="Pointage IA", layout="wide")

st.title("üìä Application de Pointage Automatique")

uploaded_file = st.file_uploader("Chargez votre fichier Excel (ex: ALAMI SAID...)", type=['xlsx'])

if uploaded_file:
    # 1. Analyse des 15 premi√®res lignes pour trouver le matricule
    header_data = pd.read_excel(uploaded_file, header=None).head(15)
    matricule = extract_matricule_precise(header_data)
    
    # 2. Chargement des donn√©es de pointage (saute les lignes d'en-t√™te)
    df = pd.read_excel(uploaded_file, skiprows=11)
    df = df.dropna(subset=[df.columns[1]]) # Nettoie les lignes vides
    
    # 3. Cr√©ation du tableau final selon votre capture
    final_table = pd.DataFrame()
    final_table['matricule'] = [matricule] * len(df)
    final_table['nom'] = "ALAMI"
    final_table['prenom'] = "SAID"
    final_table['date'] = pd.to_datetime(df.iloc[:, 1]).dt.strftime('%d/%m/%Y')
    final_table["heure d'entr√©e"] = df.iloc[:, 2]
    final_table["heure de sortie"] = df.iloc[:, 3]
    final_table["N¬∞ heures effectu√©es"] = df.iloc[:, 7].apply(decimal_to_time)

    # Affichage du r√©sultat
    st.info(f"Matricule extrait automatiquement : **{matricule}**")
    st.table(final_table)
    
    # Bouton Export
    st.download_button("T√©l√©charger le tableau (CSV)", final_table.to_csv(index=False), "resultat.csv")
